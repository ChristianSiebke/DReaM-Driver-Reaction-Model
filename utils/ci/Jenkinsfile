/*******************************************************************************
 * Copyright (c) 2021 in-tech GmbH
 *
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *******************************************************************************/

pipeline {
  agent {
    kubernetes {
      label 'openpass-agent-pod-' + env.BUILD_NUMBER
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: openpass-build
    image: rbiegel/openpass-build:latest
    tty: true
    resources:
      limits:
        memory: "16Gi"
        cpu: "4"
      requests:
        memory: "16Gi"
        cpu: "4"
    volumeMounts:
    - name: volume-known-hosts
      mountPath: /home/jenkins/.ssh
  volumes:
  - name: volume-known-hosts
    configMap:
      name: known-hosts
"""
    }
  }
  options {
    checkoutToSubdirectory('repo')
  }
  stages {
    stage('Prepare dependencies') {
      steps {
        container('openpass-build') {
          sh 'repo/utils/ci/scripts/build_prepare.sh'
        }
      }
    }
    stage('Build and E2E tests') {
      steps {
        container('openpass-build') {
          sh 'repo/utils/ci/scripts/build_core_and_e2e.sh'
        }
      }
    }
    stage('Unit tests') {
      steps {
        container('openpass-build') {
          sh 'repo/utils/ci/scripts/build_unittests.sh'
        }
      }
    }
    stage('Deploy') {
      steps {
        container('jnlp') {
          sshagent ( ['projects-storage.eclipse.org-bot-ssh']) {
            sh '''
              ssh -o BatchMode=yes genie.simopenpass@projects-storage.eclipse.org mkdir -p /home/data/httpd/download.eclipse.org/simopenpass/snapshots
              scp -o BatchMode=yes artifacts/openPASS_SIM.tar.gz genie.simopenpass@projects-storage.eclipse.org:/home/data/httpd/download.eclipse.org/simopenpass/snapshots/openPASS_SIM_$(date -u +%Y%m%d_%H%M%S).tar.gz
            '''
          }
        }
      }
    }
  }
  post {
    always {
      archiveArtifacts allowEmptyArchive: true, artifacts: 'artifacts/**', followSymlinks: false
      junit allowEmptyResults: true, testResults: 'build/**/*_Tests.xml,repo/sim/tests/endToEndTests/pyOpenPASS/result_*.xml'
    }
  }
}

